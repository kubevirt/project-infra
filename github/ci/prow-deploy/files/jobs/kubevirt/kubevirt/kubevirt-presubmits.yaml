presubmits:
  kubevirt/kubevirt:
  - name: pull-kubevirt-e2e-k8s-1.21-sig-network
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    cluster: prow-workloads
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.21-sig-network
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.21-sig-storage
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    cluster: prow-workloads
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.21-sig-storage
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.21-sig-compute
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    cluster: prow-workloads
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.21-sig-compute
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.21-operator
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    cluster: prow-workloads
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.21
            - name: KUBEVIRT_E2E_FOCUS
              value: "\\[sig-operator\\]"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.21-rest-coverage
    skip_branches:
      - release-\d+\.\d+
    annotations:
      testgrid-create-test-group: "false"
    always_run: false
    optional: true
    skip_report: false
    cluster: prow-workloads
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.21
            - name: RUN_REST_COVERAGE
              value: "true"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.20-sig-network
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    cluster: prow-workloads
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.20-sig-network
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.20-sig-storage
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    cluster: prow-workloads
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.20-sig-storage
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.20-sig-compute
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: true
    cluster: prow-workloads
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.20-sig-compute
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.20-operator
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    cluster: phx-prow
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.20
            - name: KUBEVIRT_E2E_FOCUS
              value: "\\[sig-operator\\]"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.20-cgroupsv2
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    cluster: phx-prow
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: "k8s-1.20-cgroupsv2"
            - name: KUBEVIRT_E2E_SKIP
              value: "Multus|SRIOV|GPU|Macvtap|\\[sig-operator\\]"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19-nonroot
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    cluster: phx-prow
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.19
            - name: KUBEVIRT_E2E_SKIP
              value: "SRIOV|GPU|Operator"
            - name: FEATURE_GATES
              value: "NonRoot"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"

  - name: pull-kubevirt-e2e-k8s-1.19-sig-network-nonroot
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.19-sig-network
            - name: FEATURE_GATES
              value: "NonRoot"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19-sig-storage-nonroot
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    cluster: prow-workloads
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: "TARGET"
              value: "k8s-1.19-sig-storage"
            - name: FEATURE_GATES
              value: "NonRoot"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19-operator-nonroot
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: "TARGET"
              value: "k8s-1.19"
            - name: FEATURE_GATES
              value: "NonRoot"
            - name: "KUBEVIRT_E2E_FOCUS"
              value: "Operator"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - " automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    cluster: phx-prow
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.19
            - name: KUBEVIRT_E2E_SKIP
              value: "SRIOV|GPU|\\[sig-operator\\]|\\[sig-network\\]|\\[sig-storage\\]|\\[sig-compute\\]"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19-sig-network
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.19-sig-network
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19-sig-storage
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    cluster: prow-workloads
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.19-sig-storage
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19-sig-compute
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    cluster: prow-workloads
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: k8s-1.19-sig-compute
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.19-operator
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: TARGET
              value: "k8s-1.19"
            - name: KUBEVIRT_E2E_FOCUS
              value: "\\[sig-operator\\]"
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-windows2016
    skip_branches:
    - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    decorate: true
    decoration_config:
      timeout: 2h
      grace_period: 5m
    max_concurrency: 1 # we have one license
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
      - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
        command:
        - "/usr/local/bin/runner.sh"
        - "/bin/sh"
        - "-c"
        - "export TARGET=windows2016 && automation/test.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "29Gi"
  - name: pull-kubevirt-e2e-kind-1.17-sriov-nonroot
    skip_branches:
    - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      k8s.v1.cni.cncf.io/networks: 'multus-cni-ns/sriov-passthrough-cni,multus-cni-ns/sriov-passthrough-cni'
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 30m
    max_concurrency: 10
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      sriov-pod: "true"
      rehearsal.allowed: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        hardwareSupport: sriov-nic
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: sriov-pod
                  operator: In
                  values:
                  - "true"
              topologyKey: kubernetes.io/hostname
            - labelSelector:
                matchExpressions:
                - key: sriov-pod-multi
                  operator: In
                  values:
                  - "true"
              topologyKey: kubernetes.io/hostname
      containers:
      - image: quay.io/kubevirtci/golang:v20210316-d295087
        env:
          - name: "TARGET"
            value: "kind-k8s-sriov-1.17.0"
          - name: "GIMME_GO_VERSION"
            value: "1.13.8"
          - name: FEATURE_GATES
            value: "NonRoot"
        command:
        - "/usr/local/bin/runner.sh"
        - "/bin/bash"
        - "-ce"
        - "automation/test.sh"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "29Gi"
        volumeMounts:
          #for running kind with dind (see https://github.com/kubernetes-sigs/kind/issues/303)
          - name: modules
            mountPath: /lib/modules
            readOnly: true
          - name: cgroup
            mountPath: /sys/fs/cgroup
          - name: vfio
            mountPath: /dev/vfio/
      volumes:
        - name: modules
          hostPath:
            path: /lib/modules
            type: Directory
        - name: cgroup
          hostPath:
            path: /sys/fs/cgroup
            type: Directory
        - name: vfio
          hostPath:
            path: /dev/vfio/
            type: Directory

  - name: pull-kubevirt-e2e-kind-1.17-sriov
    skip_branches:
    - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      k8s.v1.cni.cncf.io/networks: 'multus-cni-ns/sriov-passthrough-cni,multus-cni-ns/sriov-passthrough-cni'
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    decorate: true
    decoration_config:
      timeout: 4h
      grace_period: 30m
    max_concurrency: 10
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      sriov-pod: "true"
      rehearsal.allowed: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        hardwareSupport: sriov-nic
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                - key: sriov-pod
                  operator: In
                  values:
                  - "true"
              topologyKey: kubernetes.io/hostname
            - labelSelector:
                matchExpressions:
                - key: sriov-pod-multi
                  operator: In
                  values:
                  - "true"
              topologyKey: kubernetes.io/hostname
      containers:
      - image: quay.io/kubevirtci/golang:v20210316-d295087
        env:
          - name: "TARGET"
            value: "kind-k8s-sriov-1.17.0"
          - name: "GIMME_GO_VERSION"
            value: "1.13.8"
        command:
        - "/usr/local/bin/runner.sh"
        - "/bin/bash"
        - "-ce"
        - |
            automation/test.sh
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "29Gi"
        volumeMounts:
          #for running kind with dind (see https://github.com/kubernetes-sigs/kind/issues/303)
          - name: modules
            mountPath: /lib/modules
            readOnly: true
          - name: cgroup
            mountPath: /sys/fs/cgroup
          - name: vfio
            mountPath: /dev/vfio/
      volumes:
        - name: modules
          hostPath:
            path: /lib/modules
            type: Directory
        - name: cgroup
          hostPath:
            path: /sys/fs/cgroup
            type: Directory
        - name: vfio
          hostPath:
            path: /dev/vfio/
            type: Directory
  - name: pull-kubevirt-check-tests-for-flakes
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: true
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 11
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "TARGET_COMMIT=$PULL_BASE_SHA automation/repeated_test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.17-rook-ceph-nonroot
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 6
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: FEATURE_GATES
              value: "NonRoot"
            - name: TARGET
              value: k8s-1.17
            - name: KUBEVIRT_STORAGE
              value: rook-ceph-default
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.20-rook-ceph
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: false
    optional: true
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 6
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "export TARGET=k8s-1.20 && export KUBEVIRT_STORAGE=rook-ceph-default && automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-e2e-k8s-1.17-rook-ceph
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    optional: false
    skip_report: false
    decorate: true
    decoration_config:
      timeout: 7h
      grace_period: 5m
    max_concurrency: 6
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-shared-images: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    cluster: phx-prow
    spec:
      nodeSelector:
        type: bare-metal-external
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "export TARGET=k8s-1.17 && export KUBEVIRT_STORAGE=rook-ceph-default && automation/test.sh"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "29Gi"
  - name: pull-kubevirt-generate
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make generate-verify"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-verify-rpms
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: false
    skip_report: false
    optional: true
    run_if_changed: "WORKSPACE"
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make verify-rpm-deps"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-gosec
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      rehearsal.allowed: "true"
    always_run: false
    skip_report: true
    optional: true
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make gosec"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"

  - name: pull-kubevirt-build
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make && make build-verify"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-build-arm64
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          env:
            - name: BUILD_ARCH
              value: crossbuild-aarch64
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make && make build-verify"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-unit-test
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
      testgrid-dashboards: kubevirt-presubmits
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
      preset-bazel-unnested: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "make test"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-goveralls
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: true
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 10m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
      - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
        env:
          - name: COVERALLS_TOKEN_FILE
            value: /root/.docker/secrets/coveralls/token
        command:
          - "/usr/local/bin/runner.sh"
          - "/bin/sh"
          - "-c"
          - "cp /etc/bazel.bazelrc ./ci.bazelrc && if [ ${JOB_TYPE} != 'batch' ]; then make goveralls; fi"
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "8Gi"
        volumeMounts:
          - name: kubevirtci-coveralls
            mountPath: /root/.docker/secrets/coveralls
            readOnly: true
      volumes:
        - name: kubevirtci-coveralls
          secret:
            secretName: kubevirtci-coveralls-token
  - name: pull-kubevirt-apidocs
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make apidocs"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-client-python
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make client-python"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-manifests
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          # skip getting old CSVs here (no QUAY_REPOSITORY), verification might fail because of stricter rules over time; falls back to latest if not on a tag
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make manifests DOCKER_PREFIX=\"docker.io/kubevirt\" && make olm-verify"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
  - name: pull-kubevirt-prom-rules-verify
    cluster: ibm-prow-jobs
    skip_branches:
      - release-\d+\.\d+
    annotations:
      fork-per-release: "true"
    always_run: true
    skip_report: false
    optional: false
    decorate: true
    decoration_config:
      timeout: 1h
      grace_period: 5m
    labels:
      preset-dind-enabled: "true"
      preset-docker-mirror-proxy: "true"
      preset-bazel-cache: "true"
    spec:
      containers:
        - image: quay.io/kubevirtci/bootstrap:v20210311-09ebaa2
          # skip getting old CSVs here (no QUAY_REPOSITORY), verification might fail because of stricter rules over time; falls back to latest if not on a tag
          command:
            - "/usr/local/bin/runner.sh"
            - "/bin/sh"
            - "-c"
            - "cp /etc/bazel.bazelrc ./ci.bazelrc && make prom-rules-verify"
          # docker-in-docker needs privileged mode
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "4Gi"
