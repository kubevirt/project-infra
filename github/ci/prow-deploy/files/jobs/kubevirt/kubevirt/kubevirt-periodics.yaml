periodics:
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 5 * * * *
  decorate: true
  labels:
    preset-gcs-credentials: "true"
    preset-github-credentials: "true"
  name: periodic-kubevirt-flakefinder-hourly-rolling-window-report
  spec:
    containers:
    - args:
      - --dry-run=false
      - --token=/etc/github/oauth
      - --merged=24h
      - --today=true
      - --report_output_child_path=kubevirt/kubevirt
      - --skip_results_before_start_of_report=false
      - --pr_base_branch=main
      command:
      - /app/robots/cmd/flakefinder/app.binary
      image: quay.io/kubevirtci/flakefinder:v20230112-ec14f598
      name: ""
      resources: {}
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 45 0 * * *
  decorate: true
  labels:
    preset-gcs-credentials: "true"
    preset-github-credentials: "true"
  name: periodic-publish-kubevirt-flakefinder-weekly-report
  spec:
    containers:
    - args:
      - --dry-run=false
      - --token=/etc/github/oauth
      - --merged=168h
      - --report_output_child_path=kubevirt/kubevirt
      - --skip_results_before_start_of_report=false
      - --periodic_job_dir_regex=periodic-kubevirt-e2e-.*
      - --pr_base_branch=main
      command:
      - /app/robots/cmd/flakefinder/app.binary
      image: quay.io/kubevirtci/flakefinder:v20230112-ec14f598
      name: ""
      resources: {}
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 25 0 * * *
  decorate: true
  labels:
    preset-gcs-credentials: "true"
    preset-github-credentials: "true"
  name: periodic-publish-kubevirt-flakefinder-daily-report
  spec:
    containers:
    - args:
      - --dry-run=false
      - --token=/etc/github/oauth
      - --merged=24h
      - --report_output_child_path=kubevirt/kubevirt
      - --skip_results_before_start_of_report=false
      - --periodic_job_dir_regex=periodic-kubevirt-e2e-.*
      - --pr_base_branch=main
      command:
      - /app/robots/cmd/flakefinder/app.binary
      image: quay.io/kubevirtci/flakefinder:v20230112-ec14f598
      name: ""
      resources: {}
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 25 1 * * *
  decorate: true
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: project-infra
  name: periodic-push-kubevirt-flakefinder-report-values
  spec:
    containers:
    - args:
      - |
        go run robots/cmd/push-flakefinder-results/main.go --pushgateway-url=http://pushgateway.kubevirt-prow
      command:
      - /usr/local/bin/runner.sh
      - /bin/bash
      - -ce
      env:
      - name: GIMME_GO_VERSION
        value: "1.19"
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources: {}
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 25 1 * * *
  decorate: true
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: project-infra
  labels:
    preset-gcs-credentials: "true"
  name: periodic-kubevirt-push-test-metrics
  spec:
    containers:
    - args:
      - |
        go run robots/cmd/push-test-metrics/main.go \
          --pushgateway-url=http://pushgateway.kubevirt-prow
      command:
      - /usr/local/bin/runner.sh
      - /bin/bash
      - -ce
      env:
      - name: GIMME_GO_VERSION
        value: "1.21.6"
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources: {}
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  interval: 168h
  labels:
    preset-gcs-credentials: "true"
    preset-github-credentials: "true"
  name: periodic-publish-kubevirt-flakefinder-four-weekly-report
  spec:
    containers:
    - args:
      - --dry-run=false
      - --token=/etc/github/oauth
      - --merged=672h
      - --report_output_child_path=kubevirt/kubevirt
      - --skip_results_before_start_of_report=false
      - --periodic_job_dir_regex=periodic-kubevirt-e2e-.*
      - --pr_base_branch=main
      command:
      - /app/robots/cmd/flakefinder/app.binary
      image: quay.io/kubevirtci/flakefinder:v20230112-ec14f598
      name: ""
      resources: {}
- annotations:
    testgrid-alert-email: bodnopoz@redhat.com, kubevirtci-sysprep-test@googlegroups.com
    testgrid-alert-stale-results-hours: "1"
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
    testgrid-num-failures-to-alert: "1"
  cluster: kubevirt-prow-workloads
  cron: 0 0 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-docker-mirror-proxy: "true"
    preset-gcs-credentials: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-sysprep
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: TARGET
        value: windows_sysprep
      - name: KUBEVIRT_WINDOWS_PRODUCT_KEY_PATH
        value: /etc/win-sysprep/productKey
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
      volumeMounts:
      - mountPath: /etc/win-sysprep
        name: win-sysprep
    nodeSelector:
      type: bare-metal-external
    volumes:
    - name: win-sysprep
      secret:
        secretName: win-sysprep-001
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-workloads
  cron: 2 1 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 1h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: project-infra
  - base_ref: main
    org: kubevirt
    repo: kubevirt
    workdir: true
  labels:
    preset-docker-mirror-proxy: "true"
    preset-gcs-credentials: "true"
    preset-github-credentials: "true"
    preset-kubevirtci-quay-credential: "true"
    preset-podman-in-container-enabled: "true"
    preset-shared-images: "true"
  max_concurrency: 1
  name: periodic-kubevirt-push-nightly-build-main
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        set -e
        build_date="$(date +%Y%m%d)"
        cat "$QUAY_PASSWORD" | podman login --username $(cat "$QUAY_USER") --password-stdin=true quay.io
        export DOCKER_TAG="${build_date}_$(git show -s --format=%h)"
        make
        counter=3
        retval=0
        while [ $counter -gt 0 ]; do
            set +e
            make push
            retval=$?
            set -e
            if [ $retval -eq 0 ]; then
                break
            fi
            set +e
            counter=$(expr $counter - 1)
            set -e
            sleep 120
        done
        if [ $retval -ne 0 ]; then
            echo "push failed!"
            exit 1
        fi
        make build-functests
        git show -s --format=%H > _out/commit
        echo ${build_date} > _out/build_date
        bucket_dir="kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/${build_date}"
        gsutil cp ./_out/manifests/release/kubevirt-operator.yaml ./_out/manifests/release/kubevirt-cr.yaml _out/manifests/release/conformance.yaml gs://$bucket_dir/
        gsutil cp -r ./_out/manifests/testing gs://$bucket_dir/
        gsutil cp ./_out/tests/tests.test gs://$bucket_dir/testing/
        gsutil cp ./_out/cmd/dump/dump gs://$bucket_dir/testing/dump
        gsutil cp ./_out/commit gs://$bucket_dir/commit
        gsutil cp ./_out/build_date gs://kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/latest
        unset DOCKER_TAG # we want to publish to main
        export PULL_BASE_REF=main
        export GIT_ASKPASS=$PWD/../project-infra/hack/git-askpass.sh
        hack/publish-staging.sh
      env:
      - name: DOCKER_PREFIX
        value: quay.io/kubevirt
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 8Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-workloads
  cron: 2 1 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 1h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-docker-mirror-proxy: "true"
    preset-gcs-credentials: "true"
    preset-kubevirtci-quay-credential: "true"
    preset-podman-in-container-enabled: "true"
    preset-shared-images: "true"
  max_concurrency: 1
  name: periodic-kubevirt-push-nightly-build-main-ARM64
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        set -e
        build_date="$(date +%Y%m%d)"
        cat "$QUAY_PASSWORD" | podman login --username $(cat "$QUAY_USER") --password-stdin=true quay.io
        export DOCKER_TAG="${build_date}_$(git show -s --format=%h)-arm64"
        make
        counter=3
        retval=0
        while [ $counter -gt 0 ]; do
            set +e
            make push
            retval=$?
            set -e
            if [ $retval -eq 0 ]; then
                break
            fi
            set +e
            counter=$(expr $counter - 1)
            set -e
            sleep 120
        done
        if [ $retval -ne 0 ]; then
            echo "push failed!"
            exit 1
        fi
        # build functest currently does not support crossbuild, skip it
        git show -s --format=%H > _out/commit
        echo ${build_date} > _out/build_date
        bucket_dir="kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/${build_date}"
        gsutil cp ./_out/manifests/release/kubevirt-operator.yaml gs://$bucket_dir/kubevirt-operator-arm64.yaml
        gsutil cp ./_out/manifests/release/kubevirt-cr.yaml gs://$bucket_dir/kubevirt-cr-arm64.yaml
        gsutil cp -r ./_out/manifests/testing gs://$bucket_dir/testing-arm64
        gsutil cp ./_out/commit gs://$bucket_dir/commit-arm64
        gsutil cp ./_out/build_date gs://kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/latest-arm64
      env:
      - name: DOCKER_PREFIX
        value: quay.io/kubevirt
      - name: BUILD_ARCH
        value: crossbuild-aarch64
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 8Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-workloads
  cron: 2 1 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 1h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-docker-mirror-proxy: "true"
    preset-gcs-credentials: "true"
    preset-kubevirtci-quay-credential: "true"
    preset-podman-in-container-enabled: "true"
    preset-shared-images: "true"
  max_concurrency: 1
  name: periodic-kubevirt-push-nightly-build-main-s390x
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        set -e
        build_date="$(date +%Y%m%d)"
        cat "$QUAY_PASSWORD" | podman login --username $(cat "$QUAY_USER") --password-stdin=true quay.io
        export DOCKER_TAG="${build_date}_$(git show -s --format=%h)-s390x"
        make
        counter=3
        retval=0
        while [ $counter -gt 0 ]; do
            set +e
            make push
            retval=$?
            set -e
            if [ $retval -eq 0 ]; then
                break
            fi
            set +e
            counter=$(expr $counter - 1)
            set -e
            sleep 120
        done
        if [ $retval -ne 0 ]; then
            echo "push failed!"
            exit 1
        fi
        # build functest currently does not support crossbuild, skip it
        git show -s --format=%H > _out/commit
        echo ${build_date} > _out/build_date
        bucket_dir="kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/${build_date}"
        gsutil cp ./_out/manifests/release/kubevirt-operator.yaml gs://$bucket_dir/kubevirt-operator-s390x.yaml
        gsutil cp ./_out/manifests/release/kubevirt-cr.yaml gs://$bucket_dir/kubevirt-cr-s390x.yaml
        gsutil cp -r ./_out/manifests/testing gs://$bucket_dir/testing-s390x
        gsutil cp ./_out/commit gs://$bucket_dir/commit-s390x
        gsutil cp ./_out/build_date gs://kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/latest-s390x
      env:
      - name: DOCKER_PREFIX
        value: quay.io/kubevirt
      - name: BUILD_ARCH
        value: crossbuild-s390x
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 8Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 2 15 */7 * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 1h0m0s
  labels:
    preset-docker-mirror-proxy: "true"
    preset-gcs-credentials: "true"
    preset-shared-images: "true"
  max_concurrency: 1
  name: periodic-kubevirt-clean-nightly-build
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        set -e; latest_build=$(gsutil cat gs://kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/latest); delete_before_seconds=$(date -d "$latest_build - 4 weeks" +%s); for nightly_build_dir in $(gsutil ls gs://kubevirt-prow/devel/nightly/release/kubevirt/kubevirt/ | grep -E '[0-9]+\/$'); do
          build_date=$(echo "${nightly_build_dir}" | sed -E 's#^.*/([0-9]+)/$#\1#g');
          bd_seconds=$(date -d "$build_date" +%s);
          if [ $bd_seconds -lt $delete_before_seconds ]; then
            echo "Deleting $nightly_build_dir";
            gsutil -m rm -r ${nightly_build_dir};
          fi;
        done
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 200Mi
- annotations:
    testgrid-dashboards: kubevirt-periodics
  cluster: kubevirt-prow-workloads
  cron: 30 2 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 7h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    path_alias: kubevirt
    repo: kubevirt
    workdir: true
  labels:
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-shared-images: "true"
  max_concurrency: 1
  name: periodic-kubevirt-push-nightly-conformance
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/conformance.sh
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
  cluster: kubevirt-prow-workloads
  cron: 0 22, 10 * * *
  decorate: true
  decoration_config:
    grace_period: 30m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    vgpu: "true"
  max_concurrency: 1
  name: periodic-kubevirt-e2e-kind-1.27-vgpu
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: vgpu
              operator: In
              values:
              - "true"
          topologyKey: kubernetes.io/hostname
          weight: 100
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/bash
      - -ce
      - |
        automation/test.sh
      env:
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: TARGET
        value: kind-1.27-vgpu
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 18Gi
      securityContext:
        privileged: true
      volumeMounts:
      - mountPath: /sys/fs/cgroup
        name: cgroup
      - mountPath: /dev/vfio/
        name: vfio
      - mountPath: /var/log/audit
        name: audit
    nodeSelector:
      hardwareSupport: gpu
    priorityClassName: vgpu
    volumes:
    - hostPath:
        path: /sys/fs/cgroup
        type: Directory
      name: cgroup
    - hostPath:
        path: /dev/vfio
        type: Directory
      name: vfio
    - hostPath:
        path: /var/log/audit
        type: Directory
      name: audit
- annotations:
    k8s.v1.cni.cncf.io/networks: default/sriov-passthrough-cni,default/sriov-passthrough-cni
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 0 23 * * 6
  decorate: true
  decoration_config:
    grace_period: 30m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-dind-enabled: "true"
    preset-docker-mirror-proxy: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-kind-sriov
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: sriov-pod
              operator: In
              values:
              - "true"
          topologyKey: kubernetes.io/hostname
        - labelSelector:
            matchExpressions:
            - key: sriov-pod-multi
              operator: In
              values:
              - "true"
          topologyKey: kubernetes.io/hostname
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/bash
      - -ce
      - automation/test.sh
      env:
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: TARGET
        value: kind-sriov
      image: quay.io/kubevirtci/golang-legacy:v20220810-a8f2e6c
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
      volumeMounts:
      - mountPath: /lib/modules
        name: modules
        readOnly: true
      - mountPath: /sys/fs/cgroup
        name: cgroup
      - mountPath: /dev/vfio/
        name: vfio
    nodeSelector:
      hardwareSupport: sriov-nic
    priorityClassName: sriov
    volumes:
    - hostPath:
        path: /lib/modules
        type: Directory
      name: modules
    - hostPath:
        path: /sys/fs/cgroup
        type: Directory
      name: cgroup
    - hostPath:
        path: /dev/vfio/
        type: Directory
      name: vfio
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 15 22 * * 0
  decorate: true
  decoration_config:
    timeout: 1h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: project-infra
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-podman-in-container-enabled: "true"
    preset-docker-mirror: "true"
    preset-gcs-credentials: "true"
    preset-github-credentials: "true"
  max_concurrency: 1
  name: bump-kubevirt-rpms-weekly
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/bash
      - -c
      - ../project-infra/hack/git-pr.sh -c "cd ../kubevirt && make rpm-deps" -b bump-rpm-dependencies
        -p ../kubevirt -T main -R
      image: quay.io/kubevirtci/pr-creator:v20240913-6773146
      name: ""
      resources:
        requests:
          memory: 8Gi
      securityContext:
        privileged: true
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-control-plane
  cron: 35 6 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  - base_ref: main
    org: kubevirt
    repo: project-infra
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-github-credentials: "true"
    preset-kubevirtci-quay-credential: "true"
    preset-pgp-bot-key: "true"
  max_concurrency: 1
  name: periodic-kubevirt-e2e-k8s-1.26-sev
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        # install yq
        curl -Lo ./yq https://github.com/mikefarah/yq/releases/download/3.4.1/yq_linux_amd64
        chmod +x ./yq && mv ./yq /usr/local/bin/yq

        # install sshuttle and kubectl
        dnf -y install sshuttle kubernetes-client
        # get kubeconfig and ssh key
        source ../project-infra/hack/manage-secrets.sh
        decrypt_secrets
        extract_secret 'amdKubeConfig' /kubeconfig
        extract_secret 'amdSEVClusterKey' /ssh-key && chmod 400 /ssh-key

        # login quay.io
        cat "$QUAY_PASSWORD" | podman login --username $(cat "$QUAY_USER") --password-stdin=true quay.io

        # Set up tunnel
        sshuttle -v -r kubevirt@165.204.53.121 10.216.91.126/32 192.168.0.0/24 --ssh-cmd 'ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -i /ssh-key -p 30026' > /var/log/sshuttle.log 2>&1 & echo "${!}" > /var/run/sshuttle.pid

        # run test
        make cluster-up && make cluster-sync && FUNC_TEST_LABEL_FILTER='--label-filter=(SEV)' make functest && make cluster-clean || (make cluster-clean && exit 1)
      env:
      - name: TARGET
        value: external
      - name: KUBEVIRT_PROVIDER
        value: external
      - name: DOCKER_PREFIX
        value: quay.io/kubevirtci
      - name: DOCKER_TAG
        value: amd_sev_test
      - name: KUBECONFIG
        value: /kubeconfig
      - name: IMAGE_PULL_POLICY
        value: Always
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 4Gi
      securityContext:
        privileged: true
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: prow-arm64-workloads-2
  cron: 40 4 1,5,9,13,17,19 * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-unnested: "false"
    preset-podman-in-container-enabled: "true"
  max_concurrency: 5
  name: periodic-kubevirt-kind-e2e-test-ARM64
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -ce
      - automation/test.sh
      env:
      - name: TARGET
        value: kind-1.28
      - name: KUBEVIRT_PROVIDER
        value: kind-1.28
      - name: KUBEVIRT_NUM_NODES
        value: "1"
      - name: KUBEVIRT_E2E_FOCUS
        value: arm64
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 16Gi
      securityContext:
        privileged: true
      volumeMounts:
      - mountPath: /var/log/audit
        name: audit
    volumes:
    - emptyDir: {}
      name: audit
- name: periodic-kubevirt-e2e-test-S390X
  annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cron: "30 4,12,20,00 * * *"
  decorate: true
  cluster: kubevirt-prow-workloads
  decoration_config:
    timeout: 4h
    grace_period: 5m
  labels:
    preset-podman-in-container-enabled: "true"
    preset-docker-mirror-proxy: "true"
    preset-shared-images: "true"
    preset-bazel-cache: "true"
    preset-kubevirtci-quay-credential: "true"
  extra_refs:
  - org: kubevirt
    repo: kubevirt
    base_ref: main
    work_dir: true
  - org: kubevirt
    repo: project-infra
    base_ref: main
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    nodeSelector:
      type: bare-metal-external
    containers:
      - image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
        env:
          - name: TARGET
            value: "external-wg-s390x"
          - name: KUBEVIRT_PROVIDER
            value: "external"
          - name: DOCKER_PREFIX
            value: quay.io/kubevirtci
          - name: DOCKER_TAG
            value: "s390x_test"
          - name: KUBECONFIG
            value: "/kubeconfig"
          - name: IMAGE_PULL_POLICY
            value: "Always"
          - name: BUILD_ARCH
            value: "crossbuild-s390x"
          - name: GIT_ASKPASS
            value: "../project-infra/hack/git-askpass.sh"
        command:
          - "/usr/local/bin/runner.sh"
          - "/bin/sh"
          - "-c"
          - |
            # install yq
            curl -Lo ./yq https://github.com/mikefarah/yq/releases/download/3.4.1/yq_linux_amd64
            chmod +x ./yq && mv ./yq /usr/local/bin/yq

            # get kubectl
            curl -Lo ./kubectl "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl

            # get kubeconfig
            source ../project-infra/hack/manage-secrets.sh
            decrypt_secrets
            extract_secret 'kubeconfigS390x' /kubeconfig

            # login quay.io
            cat "$QUAY_PASSWORD" | docker login --username $(cat "$QUAY_USER") --password-stdin=true quay.io

            # run the test
            automation/test.sh
        # docker-in-docker needs privileged mode
        securityContext:
          privileged: true
        resources:
          requests:
            memory: "8Gi"
        volumeMounts:
          - name: token
            mountPath: /etc/github
          - name: pgp-bot-key
            mountPath: /etc/pgp
            readOnly: true
    volumes:
      - name: token
        secret:
          secretName: oauth-token
      - name: pgp-bot-key
        secret:
          secretName: pgp-bot-key
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: prow-arm64-workloads-2
  cron: 40 4 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 2h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-unnested: "false"
  max_concurrency: 10
  name: periodic-kubevirt-unit-test-Arm64
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - make test
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 8Gi
      securityContext:
        privileged: true
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: prow-s390x-workloads
  cron: 40 5 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 2h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-unnested: "true"
  max_concurrency: 10
  name: periodic-kubevirt-unit-test-s390x
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - make go-test
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 8Gi
      securityContext:
        privileged: true
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-control-plane
  cron: 40 4 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  - base_ref: main
    org: kubevirt
    repo: project-infra
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-github-credentials: "true"
    preset-kubevirtci-quay-credential: "true"
    preset-pgp-bot-key: "true"
  max_concurrency: 1
  name: periodic-kubevirt-performance-cluster-100-density-test
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        # install yq
        curl -Lo ./yq https://github.com/mikefarah/yq/releases/download/3.4.1/yq_linux_amd64
        chmod +x ./yq && mv ./yq /usr/local/bin/yq

        # get kubectl
        curl -L "https://dl.k8s.io/release/v1.19.7/bin/linux/amd64/kubectl" -o /usr/local/bin/kubectl
        chmod +x /usr/local/bin/kubectl

        # get kubeconfig
        source ../project-infra/hack/manage-secrets.sh
        decrypt_secrets
        extract_secret 'kubeconfigPerf' /kubeconfig

        # login quay.io
        cat "$QUAY_PASSWORD" | podman login --username $(cat "$QUAY_USER") --password-stdin=true quay.io

        # run test
        ./automation/perfscale-test.sh
      env:
      - name: TARGET
        value: external
      - name: KUBEVIRT_PROVIDER
        value: external
      - name: DOCKER_PREFIX
        value: quay.io/kubevirtci
      - name: DOCKER_TAG
        value: perfscale_test
      - name: KUBECONFIG
        value: /kubeconfig
      - name: PROMETHEUS_PORT
        value: "9090"
      - name: PERFAUDIT
        value: "true"
      - name: kubectl
        value: /usr/local/bin/kubectl
      - name: IMAGE_PULL_POLICY
        value: Always
      - name: PERFSCALE_WORKLOAD
        value: tools/perfscale-load-generator/examples/workload/kubevirt-density/kubevirt-burst-100.yaml
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 4Gi
      securityContext:
        privileged: true
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-control-plane
  cron: 40 15 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  - base_ref: main
    org: kubevirt
    repo: project-infra
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-github-credentials: "true"
    preset-kubevirtci-quay-credential: "true"
    preset-pgp-bot-key: "true"
  max_concurrency: 1
  name: periodic-kubevirt-performance-cluster-scale-density-test
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        # install yq
        curl -Lo ./yq https://github.com/mikefarah/yq/releases/download/3.4.1/yq_linux_amd64
        chmod +x ./yq && mv ./yq /usr/local/bin/yq

        # get kubectl
        curl -L "https://dl.k8s.io/release/v1.19.7/bin/linux/amd64/kubectl" -o /usr/local/bin/kubectl
        chmod +x /usr/local/bin/kubectl

        # get kubeconfig
        source ../project-infra/hack/manage-secrets.sh
        decrypt_secrets
        extract_secret 'kubeconfigPerf' /kubeconfig

        # login quay.io
        cat "$QUAY_PASSWORD" | podman login --username $(cat "$QUAY_USER") --password-stdin=true quay.io

        # run test 200
        PERFSCALE_WORKLOAD=$PERFSCALE_WORKLOAD_TWO_HUNDRED ./automation/perfscale-test.sh
        sleep 10m

        # run test 400
        PERFSCALE_WORKLOAD=$PERFSCALE_WORKLOAD_FOUR_HUNDRED ./automation/perfscale-test.sh
        sleep 10m

        # run test 600
        PERFSCALE_WORKLOAD=$PERFSCALE_WORKLOAD_SIX_HUNDRED ./automation/perfscale-test.sh
        sleep 30s
      env:
      - name: TARGET
        value: external
      - name: KUBEVIRT_PROVIDER
        value: external
      - name: DOCKER_PREFIX
        value: quay.io/kubevirtci
      - name: DOCKER_TAG
        value: perfscale_test
      - name: KUBECONFIG
        value: /kubeconfig
      - name: PROMETHEUS_PORT
        value: "9090"
      - name: kubectl
        value: /usr/local/bin/kubectl
      - name: IMAGE_PULL_POLICY
        value: Always
      - name: PERFSCALE_WORKLOAD_TWO_HUNDRED
        value: tools/perfscale-load-generator/examples/workload/kubevirt-density/kubevirt-burst-200.yaml
      - name: PERFSCALE_WORKLOAD_FOUR_HUNDRED
        value: tools/perfscale-load-generator/examples/workload/kubevirt-density/kubevirt-burst-400.yaml
      - name: PERFSCALE_WORKLOAD_SIX_HUNDRED
        value: tools/perfscale-load-generator/examples/workload/kubevirt-density/kubevirt-burst-600.yaml
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 4Gi
      securityContext:
        privileged: true
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 40 7,15,23 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    ci.kubevirt.io/prometheus: ""
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
  # note: when the provider is updated, the `robots/cmd/perf-report-creator/graph.sh` and
  #       `robots/cmd/perf-report-creator/scrape.sh` needs to be updated as well, refer to this
  #       https://github.com/kubevirt/project-infra/pull/3032 for the needed changes
  name: periodic-kubevirt-e2e-k8s-1.29-sig-performance
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        # Build the perfscale-audit binary
        make bazel-build

        # Create k8s cluster
        make cluster-up

        # Push and deploy kubevirt
        make cluster-sync

        FUNC_TEST_ARGS="--no-color --seed=42" make perftest
      env:
      - name: KUBEVIRT_PROVIDER
        value: k8s-1.29
      - name: KUBEVIRT_STORAGE
        value: hpp
      - name: KUBEVIRT_MEMORY_SIZE
        value: 16G
      - name: KUBEVIRT_NUM_NODES
        value: "4"
      - name: KUBEVIRT_DEPLOY_PROMETHEUS
        value: "true"
      - name: KUBEVIRT_PROVIDER_EXTRA_ARGS
        value: --prometheus-port 30007
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          cpu: "12"
          memory: 73Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 0 6 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 1h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    ci.kubevirt.io/prometheus: ""
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-performance-realtime
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        # Create k8s cluster
        make cluster-up

        # Push and deploy kubevirt
        make cluster-sync

        FUNC_TEST_ARGS="--no-color --seed=42" make realtime-perftest
      env:
      - name: KUBEVIRT_PROVIDER
        value: k8s-1.29
      - name: KUBEVIRT_STORAGE
        value: rook-ceph-default
      - name: KUBEVIRT_MEMORY_SIZE
        value: 9G
      - name: KUBEVIRT_NUM_NODES
        value: "2"
      - name: KUBEVIRT_E2E_REALTIME_PERF_TEST
        value: "true"
      - name: KUBEVIRT_E2E_CYCLIC_DURATION_IN_SECONDS
        value: "60"
      - name: KUBEVIRT_E2E_REALTIME_LATENCY_THRESHOLD_IN_MICROSECONDS
        value: "40"
      - name: KUBEVIRT_HUGEPAGES_2M
        value: "512"
      - name: KUBEVIRT_REALTIME_SCHEDULER
        value: "true"
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          cpu: "10"
          memory: 26Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 10 7,15,23 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.31-sig-compute-migrations
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: TARGET
        value: k8s-1.31-sig-compute-migrations
      - name: KUBEVIRT_NUM_NODES
        value: "3"
      - name: KUBEVIRT_STORAGE
        value: rook-ceph-default
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 0 5 * * 0
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-network-multus-v4
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - |
        # Set cluster-up to not deploy Multus V3 from manifests, instead CNAO will deploy Multus V4,
        # and make the test suite run the hotplug NICs tests.
        export KUBEVIRT_WITH_MULTUS_V3='false'
        automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-network
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 10 2,18 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-storage-root
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-storage
      - name: FEATURE_GATES
        value: Root
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 20 3,19 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-compute-root
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-compute
      - name: FEATURE_GATES
        value: Root
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 30 6,22 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-operator-root
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-operator
      - name: FEATURE_GATES
        value: Root
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 5 7 * * 6
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 1h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
    workdir: true
  - base_ref: main
    org: kubevirt
    repo: project-infra
  labels:
    preset-bazel-unnested: "true"
    preset-gcs-credentials: "true"
    preset-github-credentials: "true"
  max_concurrency: 1
  name: periodic-kubevirt-image-bump
  spec:
    containers:
    - args:
      - -ce
      - |
        make bump-images
        git-pr.sh -c "cd ../project-infra && bazelisk run //robots/cmd/uploader:uploader -- -workspace ${PWD}/../kubevirt/WORKSPACE -dry-run=false" -p ${PWD} -s 'Automated run of make bump-images and //robots/cmd/uploader:uploader' -b bump-images -r kubevirt -L release-note-none -T main
      command:
      - /bin/sh
      image: quay.io/kubevirtci/pr-creator:v20240913-6773146
      name: ""
      resources:
        requests:
          memory: 200Mi
    securityContext:
      runAsUser: 0
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  decorate: true
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: project-infra
    workdir: true
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  interval: 24h
  labels:
    preset-gcs-credentials: "true"
  name: periodic-kubevirt-quarantined-tests-daily-report
  spec:
    containers:
    - args:
      - /usr/local/bin/runner.sh
      - /bin/bash
      - -ce
      - |
        output_file_name="/tmp/index.html"
        git_commit=$(cd ../kubevirt && git --no-pager log -1 --format=%H | tr -d '\n')
        test-label-analyzer stats \
          --output-html=true \
          --config-name quarantine \
          --test-file-path $(cd ../kubevirt && pwd)/tests \
          --remote-url "https://github.com/kubevirt/kubevirt/tree/${git_commit}/tests" \
            > ${output_file_name}
          gsutil cp ${output_file_name} gs://kubevirt-prow/reports/quarantined-tests/kubevirt/kubevirt/
      command:
      - /bin/sh
      image: quay.io/kubevirtci/test-label-analyzer:v20230904-34e7ab5
      name: ""
      resources: {}
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 45 1 * * *
  decorate: true
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: project-infra
    workdir: true
  labels:
    preset-gcs-credentials: "true"
  name: periodic-kubevirt-flake-stats-daily-report
  spec:
    containers:
    - args:
      - /usr/local/bin/runner.sh
      - /bin/bash
      - -ce
      - |
        output_file=/tmp/flake-stats-14days.html
        copy_file="flake-stats-14days-$(date +%Y-%m-%d).html"
        go run ./robots/cmd/flake-stats/main.go \
          '--filter-lane-regex=.*-(root|arm64)$' \
          --output-file ${output_file} \
          --overwrite-output-file=true
        gsutil cp ${output_file} gs://kubevirt-prow/reports/flakefinder/kubevirt/kubevirt/
        gsutil cp ${output_file} gs://kubevirt-prow/reports/flakefinder/kubevirt/kubevirt/${copy_file}
      command:
      - /bin/sh
      env:
      - name: GIMME_GO_VERSION
        value: "1.19"
      image: quay.io/kubevirtci/golang:v20240911-16816d3
      name: ""
      resources: {}
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 50 3,11,19 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-network
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-network
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 0 4,12,20 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-storage
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-storage
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 10 5,13,21 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-compute
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-compute
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 20 6,14,22 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.29-sig-operator
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.29-sig-operator
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-create-test-group: "false"
  cluster: kubevirt-prow-control-plane
  cron: 45 1 * * *
  name: periodic-kubevirt-update-upcoming-changes
  decorate: true
  decoration_config:
    timeout: 1h
    grace_period: 5m
  extra_refs:
  - org: kubevirt
    repo: project-infra
    base_ref: main
    workdir: true
  - org: kubevirt
    repo: kubevirt
    base_ref: main
  labels:
    preset-github-credentials: "true"
  spec:
    containers:
    - image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      env:
      - name: GIT_AUTHOR_NAME
        value: kubevirt-bot
      - name: GIT_AUTHOR_EMAIL
        value: kubevirtbot@redhat.com
      - name: GIT_REPO_URL
        value: https://kubevirt-bot@github.com/kubevirt/sig-release.git
      command: [ "/bin/sh", "-ce" ]
      args:
      - |
        set -x
        project_infra_dir=$(cd ../project-infra && pwd)
        kubevirt_dir=$(cd ../kubevirt && pwd)
        (
          cd ..
          git clone ${GIT_REPO_URL}
          cd sig-release
          git config user.email "$GIT_AUTHOR_EMAIL"
          git config user.name "$GIT_AUTHOR_NAME"
        )
        sig_release_dir=$(cd ../sig-release && pwd)
        cd ${project_infra_dir}
        bazelisk run //releng/feature-announce -- \
            --log-level=5 \
            --output-file=${sig_release_dir}/upcoming-changes.md \
            --org kubevirt \
            --repo kubevirt \
            --path-to-repository $kubevirt_dir \
            --github-token-file /etc/github/oauth
        cd ${sig_release_dir}
        git add upcoming-changes.md
        if git diff --name-only --exit-code HEAD; then
          echo "Nothing changed" >&2
          exit 0
        fi
        git commit --signoff -m "robot //releng/feature-announce: update list of notable changes for next KubeVirt release"
        git push ${GIT_REPO_URL} HEAD:main
      resources:
        requests:
          memory: "200Mi"
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 30 4,14,22 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.30-sig-network
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.30-sig-network
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 0 3,10,21 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.30-sig-storage
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.30-sig-storage
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 10 6,15,23 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.30-sig-compute
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.30-sig-compute
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 20 7,16,23 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.30-sig-operator
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.30-sig-operator
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 40 5,13,21 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.31-sig-network
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.31-sig-network
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 10 4,12,20 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.31-sig-storage
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.31-sig-storage
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 20 7,15,23 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.31-sig-compute
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.31-sig-compute
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
- annotations:
    testgrid-dashboards: kubevirt-periodics
    testgrid-days-of-results: "60"
  cluster: kubevirt-prow-workloads
  cron: 30 0,8,16 * * *
  decorate: true
  decoration_config:
    grace_period: 5m0s
    timeout: 4h0m0s
  extra_refs:
  - base_ref: main
    org: kubevirt
    repo: kubevirt
  labels:
    preset-bazel-cache: "true"
    preset-bazel-unnested: "true"
    preset-docker-mirror-proxy: "true"
    preset-podman-in-container-enabled: "true"
    preset-podman-shared-images: "true"
    preset-shared-images: "true"
  name: periodic-kubevirt-e2e-k8s-1.31-sig-operator
  reporter_config:
    slack:
      job_states_to_report: []
  spec:
    containers:
    - command:
      - /usr/local/bin/runner.sh
      - /bin/sh
      - -c
      - automation/test.sh
      env:
      - name: KUBEVIRT_E2E_RUN_ALL_SUITES
        value: "true"
      - name: KUBEVIRT_QUARANTINE
        value: "true"
      - name: KUBEVIRT_PSA
        value: "true"
      - name: TARGET
        value: k8s-1.31-sig-operator
      image: quay.io/kubevirtci/bootstrap:v20240911-16816d3
      name: ""
      resources:
        requests:
          memory: 29Gi
      securityContext:
        privileged: true
    nodeSelector:
      type: bare-metal-external
