postsubmits:
  kubevirt/kubevirt.github.io:
  - name: push-kubevirt.github.io-master-build-and-push-to-gh-pages
    branches:
    - ^master$
    annotations:
      testgrid-create-test-group: "false"
    decorate: true
    extra_refs:
    - org: kubevirt
      repo: project-infra
      base_ref: main
    cluster: ibm-prow-jobs
    spec:
      securityContext:
        runAsUser: 0
      containers:
      - image: docker.io/library/ruby:2.7
        env:
        - name: GIT_ASKPASS
          value: ../project-infra/hack/git-askpass.sh
        - name: GIT_AUTHOR_NAME
          value: kubevirt-bot
        - name: GIT_AUTHOR_EMAIL
          value: kubevirtbot@redhat.com
        command: [ "/bin/sh", "-c" ]
        args:
        - |
          set -e
          commit=$(git show -s --format=%H)
          (
            cd ..
            git clone --branch gh-pages "https://kubevirt-bot@github.com/kubevirt/kubevirt.github.io.git" gh-pages
            cd gh-pages
            git config user.email "$GIT_AUTHOR_EMAIL"
            git config user.name "$GIT_AUTHOR_NAME"
          )
          WORK_DIR=$(cd ../gh-pages && pwd)
          echo 'en_US UTF-8' >> /etc/locale.gen
          echo "export LANG=en_US.UTF-8" > ~/.utf8
          source ~/.utf8 && bundle install && make build
          BUILD_DIR=$(pwd)/_site
          cd ${WORK_DIR}
          find . -mindepth 1 -maxdepth 1 -regextype egrep -not -regex '\./(\.git.*|\.nojekyll)' -print0 | xargs -0 rm -rf
          cp -R ${BUILD_DIR}/* .
          git add -A
          git commit --signoff -m "Postsubmit site update from $commit"
          git push "https://kubevirt-bot@github.com/kubevirt/kubevirt.github.io.git" HEAD:gh-pages
        volumeMounts:
        - name: token
          mountPath: /etc/github
      volumes:
      - name: token
        secret:
          secretName: oauth-token
