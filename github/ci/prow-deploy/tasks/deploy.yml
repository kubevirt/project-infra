- name: install pip dependencies
  pip:
    name:
      - kubernetes==11.0.0
      - openshift==0.11.2

- name: launch config rendering
  shell: |
    ./render-environment-configs.sh {{ deploy_environment }}
  args:
    chdir: "{{ project_infra_root}}/github/ci/prow-deploy/kustom"

- name: validate Kustomize result
  shell: |
    kustomize build overlays/{{ deploy_environment }}
  args:
    chdir: "{{ project_infra_root}}/github/ci/prow-deploy/kustom"

- name: Launch deployment
  shell: |
    kustomize build overlays/{{ deploy_environment }} | kubectl apply -f -
  args:
    chdir: "{{ project_infra_root}}/github/ci/prow-deploy/kustom"

- name: Shallow Clone test-infra repo
  git:
    repo: https://github.com/kubernetes/test-infra.git
    dest: "{{ testinfra_dir }}"
    version: e88598c4a7f86e0564a2d8b46ce5f729247791e6

- name: Bootstrap the full job config
  shell: |
    config-bootstrapper \
      --dry-run=false \
      --source-path=$PROJECT_INFRA_ROOT \
      --config-path=$PROW_CONFIG_PATH \
      --plugin-config=$PLUGIN_CONFIG_PATH \
      --job-config-path=$JOB_CONFIG_PATH
  environment:
    PROJECT_INFRA_ROOT: "{{ project_infra_root }}"
    JOB_CONFIG_PATH: "{{ project_infra_root }}/github/ci/prow-deploy/files/jobs/"
    PROW_CONFIG_PATH: "{{ project_infra_root }}/github/ci/prow-deploy/kustom/overlays/{{ deploy_environment }}/configs/config/config.yaml"
    PLUGIN_CONFIG_PATH: "{{ project_infra_root }}/github/ci/prow-deploy/kustom/overlays/{{ deploy_environment }}/configs/plugins/plugins.yaml"
    KUBECONFIG: "{{ kubeconfig_path }}"
  args:
    chdir: "{{ testinfra_dir }}"
