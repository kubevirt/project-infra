ARG ARCH

FROM quay.io/kubevirtci/golang:v20251022-6eb3ab1 AS builder

ENV GOPROXY=https://proxy.golang.org|direct \
    GOFLAGS="-mod=vendor -ldflags=-extldflags=\"-static\"" \
    CGO_ENABLED=0 \
    GOOS=linux \
    GOARCH=${ARCH}
# Due to https://github.com/golang/go/issues/70329 cross-compilation hangs at times.
# As a temporary workaround, we can try limiting GOMAXPROCS to relieve this issue.
# See also:
# - https://github.com/golang/go/issues/67355
# - https://github.com/golang/go/issues/68464
# - https://gitlab.com/qemu-project/qemu/-/issues/2738
# - https://github.com/openshift/dpu-operator/pull/308
ENV GOMAXPROCS=3
ENV GIMME_GO_VERSION=1.24.9

RUN set -x && \
    git clone --depth 1 --revision 03e5768a447b55381f7517a9d27bb51831893d31 https://github.com/kubernetes/test-infra.git && \
    cd ./test-infra && \
    /usr/local/bin/runner.sh /bin/sh -cex 'go mod vendor && time go build -tags netgo -o /usr/local/bin/pr-creator ./robots/pr-creator' && \
    chmod +x /usr/local/bin/pr-creator

RUN set -x && \
    cd /project-infra && \
    /usr/local/bin/runner.sh /bin/sh -cex 'time go build -tags netgo -o /usr/local/bin/labels-checker ./robots/labels-checker' && \
    chmod +x /usr/local/bin/labels-checker

FROM quay.io/kubevirtci/golang:v20251022-6eb3ab1 AS final

RUN dnf install -y \
    skopeo && \
    dnf -y clean all

COPY --from=builder /usr/local/bin/pr-creator /usr/local/bin/
COPY --from=builder /usr/local/bin/labels-checker /usr/local/bin/

RUN set -x && \
    cd /project-infra && \
    cp ./hack/git-askpass.sh ./hack/git-pr.sh /usr/local/bin && \
    chmod +x /usr/local/bin/git-askpass.sh /usr/local/bin/git-pr.sh

ENV GIT_ASKPASS=/usr/local/bin/git-askpass.sh

